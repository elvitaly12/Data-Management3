<!DOCTYPE html>
<html>
    <head>
        <title>Read CSV</title>
        <link href="https://unpkg.com/tabulator-tables@4.8.4/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.4/dist/js/tabulator.min.js"></script>
        <script type = "text/javascript" src ="papaparse.min.js"></script>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
        <link rel="stylesheet" href="hw3_design.css">

        <h1 id="title_h1">File Upload</h1>
    </head>

    <body>

        <table>
                <tr>
                    <th>
                        <input type="file" accept=".csv"  id="myFile" name="filename" onchange="file_change()">
                    </th>
                </tr>
        </table>

        <button id ="btn_submit">Submit</button>
        <button id ="btn_clear" style="visibility: hidden">Clear</button>
        <button id ="btn_download" style="visibility: hidden">Download Data</button>

        <div id="example-table" style="visibility: hidden;width: 100%;height: 380px;"></div>
        <div id="margin" style=" height: 30px"></div>
        <div id="mapid" style="visibility: hidden;width: 100%;height: 380px;"></div>

    </body>

</html>

<script>


    let myFile_obj = null;
    let filename;
    let markers;
    let btn_submit = document.getElementById('btn_submit');
    let btn_download = document.getElementById('btn_download');
    let btn_clear = document.getElementById('btn_clear');

    let table_div = document.getElementById('example-table');
    let map_div = document.getElementById('mapid');
    let title_h1 = document.getElementById('title_h1');

    var mymap = L.map('mapid').setView([40.730610, -73.935242], 12);
    var markers_group = L.layerGroup();
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2ZpcmFzdWxpbjMiLCJhIjoiY2t4YWwzMXo4MGlmNDJvbXd2azFodzd4ciJ9.yw08hD-wossSoLjZkqzkSA', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        tileSize: 512,
        zoomOffset: -1,
        id: 'mapbox/streets-v11',
        // accessToken:Token,
    }).addTo(mymap);
    mymap.invalidateSize();

    function file_change(){
        myFile_obj = document.getElementById('myFile');
        if(myFile_obj==null) return;
        filename = document.getElementById('myFile').files[0].name;
    }
    let table = new Tabulator(table_div, {
            selectable: 1,
            // data: results.data,
            //  index: "id",
            height: 355,
            layout: "fitColumns",
            pagination: "local",
            paginationSize: 10,
            columns: [
                {title: "Name", field: "name", headerFilter: "input", sorter: "string"},
                {title: "Host ID", field: "host_id", sorter: "number"},
                {title: "ID", field: "id", sorter: "number"},
                {title: "Neighbourhood", field: "neighbourhood", sorter: "number"},
                {title: "Room Type", field: "room_type", sorter: "string"},
                {title: "Price", field: "price", sorter: "number"}]
    });


    btn_submit.addEventListener("click", function (e) {
        if(myFile_obj==null) return;

        console.log("File for parsing: ", myFile_obj.files[0].name);
        let csv_button = Papa.parse(myFile_obj.files[0], {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                table.setData(results.data);
                console.log(results.data);
                table_div.style.visibility = "visible";
                map_div.style.visibility = "visible";
                btn_submit.style.visibility = "hidden";
                myFile_obj.style.visibility = "hidden";
                filename = myFile_obj.files[0].name;
                title_h1.innerHTML = "Airbnb Data";

                document.getElementById('btn_download').style.visibility = "visible";
                document.getElementById('btn_clear').style.visibility = "visible";

                var customIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [20, 33],
                    // iconAnchor: [12, 41],
                    // popupAnchor: [1, -34],
                });

                markers_group.clearLayers();
                for (let row of results.data) {
                    var marker = L.marker([row.latitude, row.longitude], {title: row.name});
                    marker.setIcon(customIcon);
                    marker.addTo(mymap);
                    markers_group.addLayer(marker);
                }
                mymap.addLayer(markers_group);

                // table = new Tabulator("#example-table", {
                //     selectable: 1,
                //     data: results.data,
                //     //height: 355,
                //     layout: "fitColumns",
                //     pagination: "local",
                //     paginationSize: 10,
                //     columns: [
                //         {title: "Name", field: "name", headerFilter: "input", sorter: "string"},
                //         {title: "Host ID", field: "host_id", sorter: "number"},
                //         {title: "ID", field: "id", sorter: "number"},
                //         {title: "Neighbourhood", field: "neighbourhood", sorter: "number"},
                //         {title: "Room Type", field: "room_type", sorter: "string"},
                //         {title: "Price", field: "price", sorter: "number"}]
                // });
                //                 console.log(table);
                console.log("here7");
               // function selected_row(row) {
               //      console.log("selected row!");
               //      row.getElement().style.backgroundColor = "#7fff00";
               //      // card_div.style.visibility = "visible";
               //      table.selectRow(parseInt(row.getData()['id']))
               //      table.scrollToRow(row.getIndex(), "center", true);
               //      zoomTo(row.getData().latitude, row.getData().longitude);
               //      // _checkValidationlatlng(row);
               //      // info_el.innerHTML = JSON.stringify(row.getData(), undefined, '\t');
               //  }


                // table.on("rowClick", function(e, row){
                //    let y =   table.on("rowSelected",()=>{});
               var x = table.on("rowSelected", function(row){
                    //row - row component for the selected row
                    console.log("selected row event handler!");
                    row.getElement().style.backgroundColor = "#7fff00";
                    // card_div.style.visibility = "visible";
                    // table.selectRow(parseInt(row.getData()['id']))
                    // table.scrollToRow(row.getIndex(), "center", true);
                    zoomTo(row.getData().latitude, row.getData().longitude);

                    //update markers and put only one!
                    // markers_group.clearLayers();
                    // // for (let row of results.data) {
                    // var marker = L.marker([row.latitude, row.longitude], {title: row.name});
                    // marker.setIcon(customIcon);
                    // marker.addTo(mymap);
                    // markers_group.addLayer(marker);
                    // // }
                    // mymap.addLayer(markers_group);
                    // zoomTo(row.latitude, row.longitude);

                    // _checkValidationlatlng(row);
                    // info_el.innerHTML = JSON.stringify(row.getData(), undefined, '\t');
                });

                 // console.log(y);
                console.log("here9");


                // table.on("rowDeselected", _onDeselect)
                // table.on("dataFiltered", function(filters, rows){
                //     // last_red_marker_latlng = "";
                //     // put_markers(rows, mymap);
                // });
            }
        });
    });

    btn_download.addEventListener("click", function () {
        console.log("are we here?");
        console.log(filename);
        table.download("csv", filename);
    });

    btn_clear.addEventListener("click", function (e) {
        table_div.style.visibility = "hidden";
        map_div.style.visibility="hidden";
        btn_submit.style.visibility = "visible";
        myFile_obj.style.visibility = "visible";
        title_h1.innerHTML = "File Upload";
        btn_download.style.visibility = "hidden";
        btn_clear.style.visibility = "hidden";
        myFile_obj.value = "";
        myFile_obj=null;
        table.clearData();
        //table = null;
        // map_view.style.visibility = "hidden";
        // input_sec.style.display = "block";
        // card_div.style.visibility = "hidden";
        // last_red_marker_latlng="";
    });


    function zoomTo(lat, lng) {
        // var lat = document.getElementById("lat").value;
        // var lng = document.getElementById("lng").value;
        // mymap.panTo(new L.LatLng(lat, lng));
        mymap.setView([lat, lng], 17);
    }


</script>