<!DOCTYPE html>
<html>
    <head>
        <title>Read CSV</title>
        <link href="https://unpkg.com/tabulator-tables@4.8.4/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.4/dist/js/tabulator.min.js"></script>
        <script type = "text/javascript" src ="papaparse.min.js"></script>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
        <link rel="stylesheet" href="hw3_design.css">

        <h1 id="title_h1">File Upload</h1>
    </head>

    <body>

        <table>
                <tr>
                    <th>
                        <input type="file" accept=".csv"  id="myFile" name="filename" onchange="file_change()">
                    </th>
                </tr>
        </table>

        <button id ="btn_submit">Submit</button>
        <button id ="btn_clear" style="visibility: hidden">Clear</button>
        <button id ="btn_download" style="visibility: hidden">Download Data</button>

        <div id="example-table" style="visibility: hidden;width: 100%;height: 380px;"></div>
        <div id="margin" style=" height: 30px"></div>
        <div id="mapid" style="visibility: hidden;width: 100%;height: 380px;"></div>

    </body>

</html>

<script>
    let myFile_obj = null;
    let filename;
    let btn_submit = document.getElementById('btn_submit');
    let btn_download = document.getElementById('btn_download');
    let btn_clear = document.getElementById('btn_clear');

    //console.log("HERE");


    let table_div = document.getElementById('example-table');
    let map_div = document.getElementById('mapid');
    let title_h1 = document.getElementById('title_h1');

    function file_change(){
         myFile_obj = document.getElementById('myFile');
         filename = document.getElementById('myFile').files[0].name;
         if(myFile_obj!=null){
             console.log("file is not null");
         } else {
             myFile_obj.value="";
             myFile_obj=null;
             console.log("file is null");
         }
    }

    btn_submit.addEventListener("click", function (e) {
        if(myFile_obj==null) return;
        console.log("here2");
        let csv_button = Papa.parse(myFile_obj.files[0], {
            download: true,
            header: true,
            complete: function (results) {
                table_div.style.visibility = "visible";
                map_div.style.visibility = "visible";
                btn_submit.style.visibility = "hidden";
                myFile_obj.style.visibility = "hidden";
                filename = myFile_obj.files[0].name;
                title_h1.innerHTML = "Airbnb Data";
                document.getElementById('btn_download').style.visibility = "visible";
                document.getElementById('btn_clear').style.visibility = "visible";

                var mymap = L.map('mapid').setView([32.7768, 35.0231], 15);
                L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2ZpcmFzdWxpbjMiLCJhIjoiY2t4YWwzMXo4MGlmNDJvbXd2azFodzd4ciJ9.yw08hD-wossSoLjZkqzkSA', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                    maxZoom: 18,
                    tileSize: 512,
                    zoomOffset: -1,
                    id: 'mapbox/streets-v11',
                    // accessToken:Token,
                }).addTo(mymap);
                mymap.invalidateSize();

                let table = new Tabulator("#example-table", {
                    selectable: 1,
                    data: results.data,
                    height: 355,
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 10,
                    columns: [
                        {title: "Name", field: "name", headerFilter: "input", sorter: "string"},
                        {title: "Host ID", field: "host_id", sorter: "number"},
                        {title: "ID", field: "id", sorter: "number"},
                        {title: "Neighbourhood", field: "neighbourhood", sorter: "number"},
                        {title: "Room Type", field: "room_type", sorter: "string"},
                        {title: "Price", field: "price", sorter: "number"}]
                });
                console.log("here3");

            }
        });
    });

    btn_download.addEventListener("click", function () {
        table.download("csv", filename);
    });

    btn_clear.addEventListener("click", function (e) {
        table_div.style.visibility = "hidden";
        map_div.style.visibility="hidden";
        btn_submit.style.visibility = "visible";
        myFile_obj.style.visibility = "visible";
        title_h1.innerHTML = "File Upload";
        btn_download.style.visibility = "hidden";
        btn_clear.style.visibility = "hidden";
        myFile_obj.value = "";
        myFile_obj=null;
        table.clearData();

        // map_view.style.visibility = "hidden";
        // input_sec.style.display = "block";
        // card_div.style.visibility = "hidden";
        // last_red_marker_latlng="";
    });


    function zoomTo() {
        var lat = document.getElementById("lat").value;
        var lng = document.getElementById("lng").value;
        // mymap.panTo(new L.LatLng(lat, lng));
        mymap.setView([lat, lng], 17);
    }


</script>