<!DOCTYPE html>
<html>
    <head>
        <title>Read CSV</title>
        <link href="https://unpkg.com/tabulator-tables@4.8.4/dist/css/tabulator.min.css" rel="stylesheet">
        <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.4/dist/js/tabulator.min.js"></script>
        <script type = "text/javascript" src ="papaparse.min.js"></script>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
        <link rel="stylesheet" href="hw3_design.css">

        <h1 id="title_h1">File Upload</h1>
    </head>

    <body>
<!--        <div class="container" id="continer" style="height: 10%">-->
        <table>
                <tr>
                    <th>
                        <input type="file" accept=".csv"  id="myFile" name="filename" onchange="file_change()">
                    </th>
                </tr>
        </table>

        <button id ="btn_submit">Submit</button>
        <button id ="btn_clear" style="visibility: hidden">Clear</button>
        <button id ="btn_download" style="visibility: hidden">Download Data</button>
<!--            </div>-->


        <table id="table1" style="visibility:hidden">
            <tr>
                <th>
                    <div id="example-table" style="visibility: hidden;height: 340px; width: 780px"></div>
                </th>
                <th>
                    <div class="card" style="visibility: hidden" id="mycard"></div>
                </th>
            </tr>
            </table>
            <div id="mapid" style="visibility: hidden;height: 375px;width: 83%"></div>




<!--            <tr>-->
<!--                 <div id="margin" style=" height: 30px"></div>-->
<!--            </tr>-->




<!--        <div class="row" style="visibility: hidden" id="row1">-->
<!--             <div class="column" id="column1" style="visibility: hidden">-->
<!--                 <div id="example-table" style="visibility: hidden;width: 66%;height: 250px;"></div>-->
<!--                 <div id="margin" style=" height: 30px"></div>-->
<!--                 <div id="mapid" style="visibility: hidden;width: 66%;height: 250px;"></div>-->
<!--             </div>-->
<!--           <div class="column" id="column2" style="visibility: hidden">-->
<!--               <div class="card" style="visibility: hidden" id="mycard"></div>-->
<!--           </div>-->
<!--        </div>-->
    </body>

</html>

<script>


    let myFile_obj = null;
    let filename;
    let markers;
    let btn_submit = document.getElementById('btn_submit');
    let btn_download = document.getElementById('btn_download');
    let btn_clear = document.getElementById('btn_clear');
    let num_user_clicks = 0;
    let table_div = document.getElementById('example-table');
    let map_div = document.getElementById('mapid');
    let title_h1 = document.getElementById('title_h1');



    let table1 = document.getElementById('table1');
    let mycard = document.getElementById('mycard');

    var mymap = L.map('mapid').setView([40.730610, -73.935242], 12);
    var markers_group = L.layerGroup();
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib2ZpcmFzdWxpbjMiLCJhIjoiY2t4YWwzMXo4MGlmNDJvbXd2azFodzd4ciJ9.yw08hD-wossSoLjZkqzkSA', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        tileSize: 512,
        zoomOffset: -1,

        id: 'mapbox/streets-v11',
        // accessToken:Token,
    }).addTo(mymap);
    mymap.invalidateSize();

    function file_change(){
        myFile_obj = document.getElementById('myFile');
        if(myFile_obj==null) return;
        filename = document.getElementById('myFile').files[0].name;
    }


      var customIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [20, 33],
                });
    let table = new Tabulator(table_div, {
            selectable: 1,
          rowSelected:function(row) {
         row.getElement().style.backgroundColor = "#A6A6DF";
         // num_user_clicks=num_user_clicks+1;
         // if(num_user_clicks==1)
         // {
         //     markers_group.clearLayers();
         // }
                    // row.getElement().style.backgroundColor = "#A6A6DF";
                    // // card_div.style.visibility = "visible";
                    // tbl.selectRow(parseInt(row.getData()['id']))
                    // tbl.scrollToRow(row.getIndex(), "center", true);
                    try {
                        if(row.getData().latitude && row.getData().longitude){
                            console.log(row.getData().latitude);
                            zoomTo(row.getData().latitude, row.getData().longitude);
                        }
                        else{
                            zoomTo(40.730610, -73.935242, 12);
                            //L.map('mapid').setView([40.730610, -73.935242], 12);
                        }
                        // var marker = L.marker([row.getData().latitude,row.getData().longitude], {title: row.name});
                        // marker.setIcon(customIcon);
                        // marker.addTo(mymap);
                        // markers_group.addLayer(marker);
                        //  mymap.addLayer(markers_group);
                         insert_my_card(row);

                    } catch (error) {
                        console.error(error.toString());

                    }
    },
         rowDeselected:function(row)
         {
             row.getElement().style.backgroundColor = "#ffffff";
             mycard.removeChild(mycard.firstChild);

          },
            // data: results.data,
            //  index: "id",
            height: 340,
            layout: "fitData",
            pagination: "local",
            paginationSize: 10,
            columns: [
                {title: "Name", field: "name", headerFilter: "input", sorter: "string"},
                {title: "Host ID", field: "host_id", sorter: "number"},
                {title: "ID", field: "id", sorter: "number"},
                {title: "Neighbourhood", field: "neighbourhood", sorter: "number"},
                {title: "Room Type", field: "room_type", sorter: "string"},
                {title: "Price", field: "price", sorter: "number"}]
    });


    btn_submit.addEventListener("click", function (e) {
        if(myFile_obj==null) return;

        console.log("File for parsing: ", myFile_obj.files[0].name);
        let csv_button = Papa.parse(myFile_obj.files[0], {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                table.setData(results.data);
                console.log(results.data);
                table_div.style.visibility = "visible";
                map_div.style.visibility = "visible";
                btn_submit.style.visibility = "hidden";
                myFile_obj.style.visibility = "hidden";
                filename = myFile_obj.files[0].name;
                title_h1.innerHTML = "Airbnb Data";


                table1.style.visibility="visible";
                mycard.style.visibility="visible";

                document.getElementById('btn_download').style.visibility = "visible";
                document.getElementById('btn_clear').style.visibility = "visible";
                markers_group.clearLayers();
                for (let row of results.data) {
                    var marker = L.marker([row.latitude, row.longitude], {title: row.name});
                    marker.setIcon(customIcon);
                    marker.addTo(mymap);
                    markers_group.addLayer(marker);
                    marker.on('click', function (e){
                        var lat = e.latlng.lat;
                        var lang = e.latlng.lng;
                        zoomTo(lat,lang);
                        row = get_raw_by_lattiude(lat,lang);
                        // insert_my_card(row);
                    });
                }
                mymap.addLayer(markers_group);
                mymap.on('movestart',function (e)
                {
                    first_check = mycard.firstChild;
                    if(first_check!=null)
                    {
                        mycard.removeChild(first_check);
                    }

                })


                // table = new Tabulator("#example-table", {
                //     selectable: 1,
                //     data: results.data,
                //     //height: 355,
                //     layout: "fitColumns",
                //     pagination: "local",
                //     paginationSize: 10,
                //     columns: [
                //         {title: "Name", field: "name", headerFilter: "input", sorter: "string"},
                //         {title: "Host ID", field: "host_id", sorter: "number"},
                //         {title: "ID", field: "id", sorter: "number"},
                //         {title: "Neighbourhood", field: "neighbourhood", sorter: "number"},
                //         {title: "Room Type", field: "room_type", sorter: "string"},
                //         {title: "Price", field: "price", sorter: "number"}]
                // });
                //                 console.log(table);
                console.log("here7");
               // function selected_row(row) {
               //      console.log("selected row!");
               //      row.getElement().style.backgroundColor = "#7fff00";
               //      // card_div.style.visibility = "visible";
               //      table.selectRow(parseInt(row.getData()['id']))
               //      table.scrollToRow(row.getIndex(), "center", true);
               //      zoomTo(row.getData().latitude, row.getData().longitude);
               //      // _checkValidationlatlng(row);
               //      // info_el.innerHTML = JSON.stringify(row.getData(), undefined, '\t');
               //  }
                        // table.on("rowSelected", function(row) {
                        //     //row - row component for the selected row
                        //     console.log("selected row event handler!");
                        //     row.getElement().style.backgroundColor = "#7fff00";
                        //     zoomTo(row.getData().latitude, row.getData().longitude);
                        // });

                    //update markers and put only one!
                    // markers_group.clearLayers();
                    // // for (let row of results.data) {
                    // var marker = L.marker([row.latitude, row.longitude], {title: row.name});
                    // marker.setIcon(customIcon);
                    // marker.addTo(mymap);
                    // markers_group.addLayer(marker);
                    // // }
                    // mymap.addLayer(markers_group);
                    // zoomTo(row.latitude, row.longitude);

                    // _checkValidationlatlng(row);
                    // info_el.innerHTML = JSON.stringify(row.getData(), undefined, '\t');

                // table.on("rowDeselected", _onDeselect)
                // table.on("dataFiltered", function(filters, rows){
                //     // last_red_marker_latlng = "";
                //     // put_markers(rows, mymap);
                // });
            }
        });
    });

    btn_download.addEventListener("click", function () {
        table.download("csv", filename);
    });

    btn_clear.addEventListener("click", function (e) {
        table1.style.visibility="hidden";
        mycard.style.visibility="hidden";
        table_div.style.visibility = "hidden";
        map_div.style.visibility="hidden";
        btn_submit.style.visibility = "visible";
        myFile_obj.style.visibility = "visible";
        title_h1.innerHTML = "File Upload";
        btn_download.style.visibility = "hidden";
        btn_clear.style.visibility = "hidden";
        myFile_obj.value = "";
        myFile_obj=null;
        table.clearData();
        mycard.removeChild(mycard.firstChild);
    });

    function zoomTo(lat, lng, zoom=17) {
        mymap.setView([lat, lng], zoom);
    }

    function insert_my_card(row)
    {
        var pre = document.createElement("pre");
        var code = document.createElement("code");
        // let json_object = JSON.stringify(row.getData(), undefined, '\t');
        // for(field of row.getData().fields){
        //     if(json_object.valueOf(field))
        //         json_object.
        // }

        code.innerHTML = JSON.stringify(row.getData(), undefined, '\t');

         pre.appendChild(code);
         first_child = mycard.firstChild;
         if (first_child!=null)
         {
                mycard.replaceChild(pre,first_child);
         }
         else
         {
             mycard.appendChild(pre);
         }
    }

    function get_raw_by_lattiude(lat,lang)
    {
        // console.log(lat);
        // console.log(lang);
       let  rows = [];
       console.log(rows);
        rows = table.getRows()
      .filter(row => row.getData().latitude==lat)
        .forEach(row => insert_my_card(row));
        // console.log(rows);
        // return row;
    }
</script>